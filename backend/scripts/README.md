# 脚本说明

## update_position_avg_cost.py

更新持仓平均成本的脚本。

### 功能

1. **尝试从 Binance 交易历史计算平均成本**
   - 使用 Binance API 的 `/api/v3/myTrades` 端点获取交易历史
   - 计算买入交易的加权平均成本
   - 公式：`平均成本 = Σ(价格 × 数量) / Σ数量`

2. **如果没有交易历史，使用当前市场价格**
   - 从 Hyperliquid 获取当前市场价格
   - 将当前价格作为开仓成本

3. **更新数据库**
   - 更新 `Position` 表的 `avg_cost` 字段
   - 如果持仓不存在，创建新记录

### 使用方法

```bash
# 在 backend 目录下运行
cd /home/ubuntu/Real-Alpha-Trader/backend
uv run python scripts/update_position_avg_cost.py

# 或者使用 python 直接运行
python scripts/update_position_avg_cost.py
```

### 注意事项

1. 确保账户已配置 Binance API 密钥
2. API 密钥需要有读取交易历史的权限
3. 脚本会处理所有配置了 API 密钥的账户
4. 每个账户的更改会单独提交，一个账户失败不影响其他账户

### 输出示例

```
============================================================
持仓平均成本更新脚本
============================================================

此脚本将：
1. 尝试从 Binance 交易历史计算平均持仓成本
2. 如果没有交易历史，使用当前市场价格作为开仓成本
3. 更新数据库中的 Position 表的 avg_cost 字段

是否继续？(y/n): y

处理账户: DeepSeek-V3.1 (ID: 1)
  找到 2 个持仓
  处理持仓: BTC (数量: 0.00028)
    ✓ 使用交易历史计算的平均成本: $106480.500000
    ✓ 更新数据库持仓 BTC 的平均成本: $0.000000 -> $106480.500000
  处理持仓: BNB (数量: 0.00525)
    ✓ 使用当前市场价格作为开仓成本: $992.015000
    ✓ 更新数据库持仓 BNB 的平均成本: $0.000000 -> $992.015000
  ✓ 账户 DeepSeek-V3.1 的持仓更新完成

============================================================
更新完成！
  总更新持仓数: 2
  使用交易历史计算: 1
  使用当前市场价格: 1
============================================================
```

